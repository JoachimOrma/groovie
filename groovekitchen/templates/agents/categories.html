{% extends 'utilities/layout.html' %}

{% block main %}

<div class="container" style="min-height: 420px; margin-top: 20px">
    <p class="fs-5 mt-3 mb-5 p-2 fst-italic text-dark bg-light" id="results"></p>
    <div class="row g-md-4 g-2 mx-1 mx-lg-0" id="product-container">
        
    </div>
</div>

{% endblock main %}
{% block customJS %}
<script>
    
    //Handling searching for products
    $('.search-button').click(function(){
        const searchInput = $('#search-box').val().trim();
        if (searchInput){
            $.ajax({
                url: "/search-result/",
                type: "POST",
                data: {"csrf_token": "{{csrf_token()}}", "searchInput": searchInput},
                success: function(response){
                    if (response.status === 'success'){
                        let resultsHtml = '';
                        if (response.count_results > 1){ resultsHtml += `Your search returned ${response.count_results} results.`; } 
                        else { resultsHtml += `Your search returned ${response.count_results} result.`; }
                    
                        const useronline = "{{session.get('useronline')}}"; 
                        let productHtml = "";
                        $("#product-container").empty();
        
                        response.product_list.forEach(product => {
                            // Determine online status icon
                            let wishlistHtml = '';
                            let cartButtonHtml = '';

                            // Wishlist html based on the users wishlsit details
                            if (useronline) {
                                if (product.wishlist_deets) {
                                    wishlistHtml += `
                                        <a type="button" class="d-flex justify-content-center mt-1 wishlist">
                                            <i class="fa-solid fa-heart wishlistIcon fs-5"></i>
                                        </a>
                                        <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                    `;
                                } else {
                                    wishlistHtml += `
                                        <a type="button" class="d-flex justify-content-center mt-1 wishlist">
                                            <i class="fa-regular fa-heart wishlistIcon fs-5"></i>
                                        </a>
                                        <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                    `;
                                }
                            } else {
                                // User is not online
                                wishlistHtml += `
                                    <a type="button" class="d-flex justify-content-center mt-1 wishlist" data-bs-target="#loginModal" data-bs-toggle="modal">
                                        <i class="fa-regular fa-heart wishlistIcon fs-5"></i>
                                    </a>
                                `;
                            }

                            // Cart button based on users online status
                            if (useronline){
                                cartButtonHtml += `<a type="button" class="text-body add-to-cart"><i class="fa fa-shopping-cart text-primary me-2"></i>Add to cart</a>`;
                            } else {
                                cartButtonHtml += `<a type="button" class="text-body" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fa fa-shopping-cart text-primary me-2"></i>Add to cart</a>`;
                            }
                            const images = product.image.split('*');
                            if (images.length > 0) {
                                productHtml += `
                                    <div class="col-lg-3 col-md-4 col-6">
                                        <div class="product-item">
                                            <div class="position-relative bg-light overflow-hidden">
                                                <img class="w-100" src="/static/products/${images[0]}" alt="..." height="120" title="Click image to view product details">
                                                <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                            </div>
                                            <div class="text-center p-2">
                                                <a class="d-block text-dark mb-2" href="#">${product.name}</a>
                                                <span class="text-primary text-center">
                                                N${product.price}
                                                </span>
                                                <div class="d-flex mt-2">
                                                    <small class="w-75 text-center py-2 border">
                                                        ${cartButtonHtml}
                                                        <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                                    </small>
                                                    <small class="w-25 py-2 border">
                                                        ${wishlistHtml}
                                                    </small>
                                                </div>      
                                            </div>
                                        </div>
                                    </div>
                                `;
                            };
                        });
                        $("#product-container").append(productHtml);
                        $("#results").text(resultsHtml);

                    } else if (response.status === 'not-found'){
                        $('#product-container').html('<p class="d-flex justify-content-center">No matching products found.</p>');
                    }
                },
                error: function(error){
                    $('#product-container').html('<p class="d-flex justify-content-center">Something went wrong. Please, try again.</p>');
                }
            });
        }
    });

    //Fetching and displaying products based on the search on the home page
    document.body.onload = function(){
        const searchInput = "{{searchInput}}"
        $.post({
            url: `/search-result/`,
            data: {"csrf_token": "{{csrf_token()}}", "searchInput": searchInput},
            success: function(response){
                if (response.status === 'success'){
                    let resultsHtml = '';
                    if (response.count_results > 1){ resultsHtml += `Your search returned ${response.count_results} results.`; } 
                    else { resultsHtml += `Your search returned ${response.count_results} result.`; }
                   
                    const useronline = "{{session.get('useronline')}}"; 
                    let productHtml = "";
                    $("#product-container").empty();
    
                    response.product_list.forEach(product => {
                        // Determine online status icon
                        let wishlistHtml = '';
                        let cartButtonHtml = '';

                        // Wishlist html based on the users wishlsit details
                        if (useronline) {
                            if (product.wishlist_deets) {
                                wishlistHtml += `
                                    <a type="button" class="d-flex justify-content-center mt-1 wishlist">
                                        <i class="fa-solid fa-heart wishlistIcon fs-5"></i>
                                    </a>
                                    <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                `;
                            } else {
                                wishlistHtml += `
                                    <a type="button" class="d-flex justify-content-center mt-1 wishlist">
                                        <i class="fa-regular fa-heart wishlistIcon fs-5"></i>
                                    </a>
                                    <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                `;
                            }
                        } else {
                            // User is not online
                            wishlistHtml += `
                                <a type="button" class="d-flex justify-content-center mt-1 wishlist" data-bs-target="#loginModal" data-bs-toggle="modal">
                                    <i class="fa-regular fa-heart wishlistIcon fs-5"></i>
                                </a>
                            `;
                        }

                        // Cart button based on users online status
                        if (useronline){
                            cartButtonHtml += `<a type="button" class="text-body add-to-cart"><i class="fa fa-shopping-cart text-primary me-2"></i>Add to cart</a>`;
                        } else {
                            cartButtonHtml += `<a type="button" class="text-body" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fa fa-shopping-cart text-primary me-2"></i>Add to cart</a>`;
                        }
                        const images = product.image.split('*');
                        if (images.length > 0) {
                            productHtml += `
                                <div class="col-lg-3 col-md-4 col-6">
                                    <div class="product-item">
                                        <div class="position-relative bg-light overflow-hidden">
                                            <img class="w-100" src="/static/products/${images[0]}" alt="..." height="120" title="Click image to view product details">
                                            <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                        </div>
                                        <div class="text-center p-2">
                                            <a class="d-block text-dark mb-2" href="#">${product.name}</a>
                                            <span class="text-primary text-center">
                                               N${product.price}
                                            </span>
                                            <div class="d-flex mt-2">
                                                <small class="w-75 text-center py-2 border">
                                                    ${cartButtonHtml}
                                                    <input type="hidden" name="cartItem" class="cartItem" value="${product.id}">
                                                </small>
                                                <small class="w-25 py-2 border">
                                                    ${wishlistHtml}
                                                </small>
                                            </div>      
                                        </div>
                                    </div>
                                </div>
                            `;
                        };
                    });
                    $("#product-container").append(productHtml);
                    $("#results").text(resultsHtml);

                } else if (response.status === 'not-found'){
                    $('#product-container').html('<p class="d-flex justify-content-center">No matching products found.</p>');
                }
            },
            error: function(error){
                $('#product-container').html('<p class="d-flex justify-content-center">Something went wrong. Please, try again.</p>');
            }
        });
    }

     // Add products to cart
    document.addEventListener('DOMContentLoaded', function() {
        const addToCartButtons = document.querySelectorAll('.add-to-cart');
      
        addToCartButtons.forEach(button => {
          button.addEventListener('click', function(event) {
            event.preventDefault(); 
            const cartItemInput = button.nextElementSibling;
      
            if (cartItemInput && cartItemInput.classList.contains('cartItem')) {
              const cart_id = cartItemInput.value;
      
              $.ajax({
                url: `/add-to-cart/${cart_id}/`,
                type: 'POST',
                data: { csrf_token: '{{csrf_token()}}' }, 
                success: function(response) {
                  if (response.status === 'success') {
                    // Show a success message (you can customize this further)
                    swal({
                      text: 'Item added to cart',
                      icon: 'success',
                      buttons: false,
                      timer: 2000,
                    });
                  }
                },
              });
            }
          });
        });
    });
      

    //View Product Details
    document.addEventListener('DOMContentLoaded', function() {
        const addToCart = document.querySelectorAll('.product-details');   
        addToCart.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const cartItemInput = link.nextElementSibling;
                
                if (cartItemInput && cartItemInput.classList.contains('cartItem')) {
                    const cart_id = cartItemInput.value;
                    $.ajax({
                        url: `/product-details/${cart_id}/`,
                        type: "POST",
                        data: {"csrf_token": "{{csrf_token()}}"},
                        success: function(response){
                            window.location.href=`/product-details/${cart_id}/`
                        }
                    })
                }
            })
        })
    })
</script>

{% endblock customJS %}